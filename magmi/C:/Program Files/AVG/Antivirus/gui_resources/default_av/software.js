//{"name":"software","version":"1.2.1288","created":"2023-07-12T11:53:23.997Z"}
import t from"./ractive.js";import{napiUtils as e,productModel as s,ipmService as n}from"./napiExtensions.js";import{logger as o}from"./libs.js";import{eventer as a,serviceRequest as i}from"./napi.js";import{modals as r}from"./ractiveComponents.js";import{nls as d}from"./i18n.js";const l={v:3,t:[{t:4,f:[{t:7,e:"div",a:{class:"kin_scan__result"},f:[{t:7,e:"h1",a:{class:"h1 smr_progress__title","data-test":"ss_scanForUpdates_progress"},f:[{t:3,x:{r:["nls","scannerData.progress"],s:'_0("softwarehealth.ss2.progress.title",_1)'}}]}," ",{t:7,e:"p",a:{class:"kin_scan__subtitle"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.progress.subtitle")'}}]}]}," ",{t:7,e:"div",a:{class:"kin_scan__actions"},f:[{t:7,e:"kin-button",a:{type:"secondary","data-test":"ss_scanForUpdates_stop"},v:{click:"stop"},f:[{t:3,x:{r:["nls"],s:'_0("global.stopScan")'}}]}]}],n:50,x:{r:["scannerData.status"],s:'_0!=="done"'}},{t:4,n:51,f:[{t:4,n:50,x:{r:["scannerData.issuesCount","noProducts"],s:"_0===0||_1"},f:[{t:7,e:"div",a:{class:"kin_scan__result"},f:[{t:7,e:"h1",a:{class:"h1 kin_scan__title","data-test":"ss_scanForUpdates_titleEmpty"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.noIssues.title")'}}]}," ",{t:7,e:"p",a:{class:"kin_scan__subtitle"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.noIssues.subtitle")'}}]}]}," ",{t:7,e:"div",a:{class:"kin_scan__actions"},f:[{t:7,e:"kin-button",v:{click:"next"},a:{"data-test":"ss_scanForUpdates_next"},f:[{t:3,x:{r:["nls"],s:'_0("global.next")'}}]}]}]},{t:4,n:50,x:{r:["scannerData.issuesCount","noProducts","products.length"],s:"(!(_0===0||_1))&&(_2>0)"},f:[" ",{t:7,e:"View",a:{csscls:"-center",loading:[{t:2,r:"loading"}],actionbar:"true"},f:[{t:7,e:"div",a:{slot:"description"},f:[{t:4,f:[{t:7,e:"h1",a:{class:"h1 kin_scan__title","data-test":"ss_scanForUpdates_title"},f:[{t:3,x:{r:["nls","productsToBeUpdated"],s:'_0("softwarehealth.ss2.results.title",_1)'}}]}," ",{t:7,e:"p",a:{class:"kin_scan__subtitle"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.results.subtitle")'}}]}],n:50,x:{r:["productsToBeUpdated"],s:"_0>0"}},{t:4,n:51,f:[{t:7,e:"h1",a:{class:"h1 kin_scan__title"},f:[{t:7,e:"span",a:{class:"color-ok -text","data-test":"ss_scanForUpdates_titleResolved"},f:[{t:3,x:{r:["nls"],s:'_0("global.allUpdated")'}}]}]}," ",{t:7,e:"p",a:{class:"kin_scan__subtitle"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.allUpdated.subtitle")'}}]}],x:{r:["productsToBeUpdated"],s:"_0>0"}}]}," ",{t:7,e:"div",a:{slot:"view-content"},f:[{t:4,f:[{t:7,e:"kin-table",a:{datalength:[{t:2,r:"products.length"}],selecteditems:"1",inactive:[{t:2,r:"isResolving"}]},f:[{t:7,e:"div",a:{slot:"table-header",role:"row",class:"swu_table__header -smartscanV2"},f:[{t:7,e:"div",a:{class:"kin_table__checkbox"},f:[{t:7,e:"input",v:{click:"selectAllProducts"},a:{type:"checkbox",class:["checkbox ",{t:4,f:["-checked"],n:50,x:{r:["productsToBeUpdated","selectedProducts.length"],s:"_0===0||(_0===_1&&_1>0)"}}," "],disabled:[{t:2,x:{r:["productsToBeUpdated","failedProducts.length"],s:"_0===0||_0===_1"}}],checked:[{t:2,x:{r:["selectedProducts.length"],s:"_0>0"}}],"aria-label":[{t:2,x:{r:["nls"],s:'_0("global.selectAllItems")'}}]},m:[{t:4,f:['aria-checked="mixed"'],n:50,x:{r:["productsToBeUpdated","selectedProducts.length"],s:"_0!==_1&&_1>0"}}]}]}," ",{t:7,e:"div",a:{role:"columnheader"},f:[{t:3,x:{r:["nls"],s:'_0("global.appName")'}}]}," ",{t:7,e:"div",a:{role:"columnheader"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.version")'}}]}," ",{t:7,e:"div"}]}," ",{t:7,e:"div",a:{slot:"table-body"},f:[{t:4,f:[{t:7,e:"SmartScanItem",a:{product:[{t:2,r:"."}],selectedByDefault:"true",ignorable:"false",index:[{t:2,r:"@index"}]}}],n:52,r:"products"}]}," ",{t:7,e:"div",a:{slot:"table-empty-icon"},f:[{t:7,e:"Illustration",a:{name:"empty-table",nameSpaghetti:"i-l-079"}}]}," ",{t:7,e:"div",a:{slot:"table-empty"},f:[{t:7,e:"p",f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.empty.desc")'}}]}]}]}],n:50,r:"products.length"}]}," ",{t:7,e:"div",a:{slot:"view-actions"},f:[{t:4,f:[{t:4,f:[{t:7,e:"div",f:[{t:2,x:{r:["nls"],s:'_0("global.feeling.disconnected.desc")'}}]}," ",{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}],n:50,r:"isOffline"},{t:4,n:51,f:[{t:4,f:[{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}],n:50,r:"resolvingTakesTooLong"}," ",{t:7,e:"Progress",a:{asymptotic:"true",percentage:[{t:2,r:"progress"}],cssCls:"kin_actions__progress"}}," ",{t:7,e:"h4",a:{class:"h4"},f:[{t:3,x:{r:["nls","numberOfResolvingIssues"],s:'_0("softwarehealth.ss2.resolveInProgress.desc",_1)'}}]}],r:"isOffline"}],n:50,r:"isResolving"},{t:4,n:51,f:[{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length"],s:"_0===0||_0===_1"},f:[{t:7,e:"div",f:[{t:7,e:"kin-button",a:{size:"small","data-test":"ss_scanForUpdates_next"},v:{click:"next"},f:[{t:3,x:{r:["nls"],s:'_0("global.next")'}}]}]}]},{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length","isOffline"],s:"(!(_0===0||_0===_1))&&(_2)"},f:[" ",{t:7,e:"div",f:[{t:2,x:{r:["nls"],s:'_0("global.feeling.disconnected.desc")'}}]}," ",{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}]},{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length","isOffline","selectedProducts.length","selectableProducts.length"],s:"(!(_0===0||_0===_1))&&((!(_2))&&(_3===_4))"},f:[" ",{t:7,e:"div",a:{class:"kin_actions__left"},f:[{t:3,x:{r:["nls","selectedProducts.length"],s:'_0("softwarehealth.ss2.applicationsSelected",_1)'}}]}," ",{t:7,e:"div",f:[{t:7,e:"kin-button",a:{size:"small","data-test":"ss_scanForUpdates_resolve"},v:{click:"updateSelected"},f:[{t:3,x:{r:["nls"],s:'_0("global.updateAll")'}}]}]}," ",{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}]},{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length","isOffline","selectableProducts.length","selectedProducts.length"],s:"(!(_0===0||_0===_1))&&((!(_2))&&((!(_4===_3))&&(_4===0)))"},f:[" ",{t:7,e:"div",f:[{t:7,e:"kin-button",a:{size:"small","data-test":"ss_scanForUpdates_selectAll"},v:{click:"selectAll"},f:[{t:3,x:{r:["nls"],s:'_0("global.selectAll")'}}]}]}," ",{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}]},{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length","isOffline","selectedProducts.length","selectableProducts.length"],s:"(!(_0===0||_0===_1))&&((!(_2))&&((!(_3===_4))&&((!(_3===0))&&(_3<_4))))"},f:[" ",{t:7,e:"div",a:{class:"kin_actions__left"},f:[{t:3,x:{r:["nls","selectedProducts.length"],s:'_0("softwarehealth.ss2.applicationsSelected",_1)'}}]}," ",{t:7,e:"div",f:[{t:7,e:"kin-button",a:{size:"small","data-test":"ss_scanForUpdates_resolve"},v:{click:"updateSelected"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.updateSelected")'}}]}]}," ",{t:7,e:"div",a:{class:"kin_actions__right"},f:[{t:7,e:"button",a:{class:"a","data-test":"ss_scanForUpdates_skip"},v:{click:"skip"},f:[{t:3,x:{r:["nls"],s:'_0("global.skipForNow")'}}]}]}]},{t:4,n:50,x:{r:["productsToBeUpdated","failedProducts.length","isOffline","selectedProducts.length","selectableProducts.length"],s:"(!(_0===0||_0===_1))&&((!(_2))&&((!(_3===_4))&&((!(_3===0))&&(!(_3<_4)))))"},f:[" ",{t:7,e:"div",f:[{t:7,e:"kin-button",a:{size:"small","data-test":"ss_scanForUpdates_next"},v:{click:"next"},f:[{t:3,x:{r:["nls"],s:'_0("global.next")'}}]}]}]}],r:"isResolving"}]}]}]}],x:{r:["scannerData.status"],s:'_0!=="done"'}}]},c=Date.now()-12096e5,u=e.supportedSince("21.4"),p={ready:"ready",running:"running",stopping:"stopping",stopped:"stopped",offline:"offline",starting:"starting"},h={PROGRAM_RUNNING:"4",REBOOT_REQUIRED:"5",PROGRAM_RUNNING_USR2:"7"},g={upToDate:"UPTODATE",checking:"CHECKING",readyToInstall:"READYTOINSTALL",updateAvailable:"UPDATEAVALIABLE",waitForAutoInstall:"WAITFORAUTOINSTALL",installing:"INSTALLING",downloading:"DOWNLOADING",failed:"FAILED"},f={updated:"updated",outdated:"outdated",ignored:"ignored",recentlyUpdated:"recentlyUpdated"},_={loading:0,done:1,failed:2},S=function(){const t={};for(const e in f)t[e]=[];return t},T=function(){const t={};return t[f.outdated]=0,t[f.ignored]=0,t},m=new t({data:()=>({STATUSES:p,PRODUCT_STATUSES:g,PRODUCT_TYPES:f,INIT_STATUSES:_,ERRORS:h,initStatus:_.loading,initialized:!1,pendingUpdates:0,status:null,autoUpdate:!1,products:S(),productConfigs:{},selectedProductCounts:T(),selectedProducts:[],selectableProducts:[],productsToUpdate:new Set,successfullyUpdatedProducts:[],scanning:!1}),computed:{loading:function(){const t=this.get("status");return!this.get("initialized")&&(this.get("initStatus")===_.loading||t===p.running||t===p.starting||t===p.stopping||t===p.offline)},error:function(){return!this.get("loading")&&this.get("initStatus")===_.failed||this.get("status")===p.stopped}},_userCount:0,initialize(t=!0){if(0===this._userCount){this.log=o.createLogger("softwareupdater.serviceProxy"),this.log.info("init"),this.scanOnInit=t,this.iconCache={},this.updateStatusTimeoutIds=[],this.set("products",S()),this.observe("products.updated",(t=>{setTimeout((()=>{const e=t.filter((t=>null==t.updateTimestamp||1e3*t.updateTimestamp>c));this.merge("products.recentlyUpdated",e,{compare:"productId"})}))}));const e=t=>{setTimeout((()=>{let e=t;const s=this.get("productConfigs");this.isSmartScanV2&&(e=e.filter((t=>{const e=[p.failed,p.waitForAutoInstall,p.updateAvailable].includes(t.status),n=s[t.productId].justUpdated;return s[t.productId].canBeSelected&&(e||!n)}))),this.set("selectableProducts",e);const n=e.filter((t=>s[t.productId]?.selected&&!s[t.productId]?.justUpdated)).map((t=>t.productId));this.set("selectedProducts",n)}))};return this.observe("products.outdated",e),this.observe("productConfigs",(()=>{this._updatedSelectedProductCounts()})),this._offStatusChanged=a.on("softwareupdater.onStatusChanged",this._onStatusChanged.bind(this)),this._startRefreshingModel(),this.updateStatus()}this._userCount++},setSmartScanV2(t){this.isSmartScanV2=!!t},destroy(){this._userCount=Math.max(this._userCount-1,0),0===this._userCount&&(this.setSmartScanV2(!1),this.teardown(),this._offStatusChanged&&this._offStatusChanged(),this._stopRefreshingModel(),this.updateStatusTimeoutIds?.length&&this.updateStatusTimeoutIds.forEach((t=>{clearTimeout(t)})),this.set({initStatus:_.loading,status:null,autoUpdate:!1,products:S(),productConfigs:{},selectedProductCounts:T(),selectedProducts:[],selectableProducts:[]}),this.initialized=!1)},updateStatus(){return this.log.info("updating status data"),i("app.softwareupdater.GetStatus").then((t=>{this.log.info("status data successfully updated"),this._onStatusChanged(t)})).catch((t=>{throw this.log.error("updating status data failed",t),this.get("initStatus")!==_.done&&this.set("initStatus",_.failed),t}))},toggleProductSelection(t){const e=!this.get("productConfigs."+t+".selected");this.get("productConfigs."+t+".canBeSelected")?(this.log.info("toggle selection; productId: "+t+", newValue: "+e),this.set("productConfigs."+t+".selected",e)):(this.log.warn("rejecting to toggle selection.. setting it to false; productId: "+t),this.set("productConfigs."+t+".selected",!1))},toggleProductExpansion(t){const e=!this.get("productConfigs."+t+".expanded");this.log.info("toggle expansion; productId: "+t+", newValue: "+e),this.set("productConfigs."+t+".expanded",e)},scanProducts(t=!1){if(this.get("scanning")&&this.scanningPromise)return this.scanningPromise;{this.log.info("scanning new products");const e=i("app.softwareupdater.Scan"),s=new Promise((e=>{setTimeout(e,t||0)}));return this.scanningPromise=Promise.all([e,s]),this.set("scanning",!0),this.scanningPromise.then((t=>t[0])).finally((()=>new Promise((t=>{setTimeout((()=>{this.get("status")===p.running?this.statusReadyResolve=t:t()}),500)})))).finally((()=>{this.set("scanning",!1),this.statusReadyResolve=null}))}},isAutoUpdateLicensed(){const t=s.getProduct();return["premier","business","business_soho","asop","one_pro","one_free"].includes(t)},upgrade(){return this.log.info("autoUpdate is not allowed for current license.. opening NAG"),n.openWindow(343),Promise.resolve()},toggleAutoUpdate(){if(this.isAutoUpdateLicensed()){const t=this.get("autoUpdate");return this.log.info("switching autoUpdate "+(t?"off":"on")),i("app.softwareupdater."+(t?"Disable":"Enable")+"AutoUpdate").then((()=>this.set("autoUpdate",!t)))}return this._openCuSwUpdater()},_openCuSwUpdater(){return i("app.lis.get.install",{ids:["tu"]}).then((t=>!0===((t&&t.products||{}).cleanup||{}).installed)).then((t=>t?i("public.Cleanup.UI.OpenMainWindow",{view:"software-updater"}):this.upgrade())).catch((t=>t&&t.exception&&4294967295===t.exception.code?i("app.lis.open.ui",{id:"tu"}).then((()=>{setTimeout((()=>{i("public.Cleanup.UI.OpenMainWindow",{view:"software-updater"})}),1500)})):this.upgrade()))},start(){return this.log.info("starting software updater"),i("app.softwareupdater.StartSoftwareUpdater")},stop(){return this.log.info("stopping software updater"),i("app.softwareupdater.StopSoftwareUpdater")},updateSelectedProducts(){this.log.info("gonna updated selected products");const t=this._getSelectedProductIds(f.outdated),e=this.get("productsToUpdate");return t.forEach(e.add,e),this.set("productsToUpdate",e),t.length?(t.forEach((t=>{this._cancelProductExpansion(t)})),i("app.softwareupdater.UpdateSoftwareList",{softwareIDs:t}).then(this.updateStatus.bind(this))):(this.log.warn("no product selected.. should not have got here"),Promise.reject())},updateProduct(t){this.log.info("gonna update product; productId: "+t);const e=this.get("productsToUpdate");return e.add(t),this.set("productsToUpdate",e),i("app.softwareupdater.UpdateSoftwareList",{softwareIDs:[t]})},ignoreSelectedProducts(){this.log.info("gonna ignore selected products");const t=this._getSelectedProductIds(f.outdated);return t.length?(t.forEach((t=>{this._cancelProductExpansion(t)})),i("app.softwareupdater.IgnoreSoftwareList",{softwareIDs:t}).then(this.updateStatus.bind(this))):(this.log.warn("no product selected.. should not have got here"),Promise.reject())},selectProduct(t,e){const s=this.get("selectedProducts");e?this.isProductSelected(t.productId)||s.push(t.productId):s.splice(s.indexOf(t.productId),1),this.set("productConfigs."+t.productId+".selected",e),this.set("selectedProducts",s)},selectAllProducts(t){const e=this.get("selectableProducts").filter((t=>t.productConfig?.canBeSelected));this.set("selectedProducts",[]);const s=e.map((t=>t.productId));t&&this.set("selectedProducts",s);for(const n of s)this.set("productConfigs."+n+".selected",t)},isProductSelected(t){return this.get("selectedProducts").includes(t)},_includeStatuses:(t,e)=>t&&e.includes(t.STATUS),isUpdateInProgress(t){const e=[g.downloading,g.installing],s=this._includeStatuses(t,e),n=this.get("productConfigs."+t.PRODUCTID+".justUpdated");return s||n},ignoreProduct(t){return this.log.info("gonna ignore product; productId: "+t),this._cancelProductExpansion(t),i("app.softwareupdater.IgnoreSoftwareList",{softwareIDs:[t]})},unignoreProduct(t){return this.log.info("gonna unignore product; productId: "+t),i("app.softwareupdater.UnignoreSoftwareList",{softwareIDs:[t]})},resetSuccessfullyUpdatedProducts(){this.set("successfullyUpdatedProducts",[])},_onStatusChanged(t){this.log.info("status data changed"),"string"==typeof(t=t||{})&&(t=JSON.parse(t));const e=this.get("status");if(this.get("initStatus")!==_.done&&!this.scanOnInit||t.status!==p.ready||e===p.ready||e===p.running){if(t.status===p.running&&this.get("status")!==p.running){this.stopStatusPolling&&this.stopStatusPolling();const t=setInterval(this.updateStatus.bind(this),3e3);this.stopStatusPolling=()=>{clearInterval(t),this.stopStatusPolling=null}}else t.status!==p.running&&this.stopStatusPolling&&this.stopStatusPolling();this.set("status",t.status),t.status===p.ready&&this.statusReadyResolve&&this.statusReadyResolve(),t.status===p.ready&&this.set("initialized",!0),this.set("autoUpdate","true"===t.autoupdate_enabled),t.PRODUCTS&&t.PRODUCTS.length&&this._setProducts(t.PRODUCTS).then((()=>{const e=t.PRODUCTS.reduce(((t,e)=>t+=0|this.isUpdateInProgress(e)),0);this.set("pendingUpdates",e);const s=this.get("productsToUpdate"),n=this.get("products.outdated"),o=this.get("successfullyUpdatedProducts");t.PRODUCTS.forEach((t=>{(t=>t.STATUS===g.failed||t.DISPLAYERROR===h.PROGRAM_RUNNING||t.DISPLAYERROR===h.PROGRAM_RUNNING_USR2||t.DISPLAYERROR===h.REBOOT_REQUIRED)(t)&&s.delete(t.PRODUCTID)}));const a=[...s].filter((t=>!n.find((e=>e.productId===t)))),i=o.concat(a);i.forEach(s.delete,s),this.set("productsToUpdate",s),this.set("successfullyUpdatedProducts",i)}))}else this.scanProducts().catch((()=>{this.set("initStatus",_.failed)}))},_setProducts(t){this.log.info("setting products and updating their configs",t);const e=function(t){return"true"===t.HIDDEN?(this.log.info("not adding hidden product; productId: "+t.PRODUCTID),Promise.resolve()):this._loadIcon(t.ICON&&t.ICON.PATH).then((e=>{this.log.info("product icon loaded; productId: "+t.PRODUCTID);const a=t.FLAGS&&"true"===t.FLAGS.WINDOWSUPDATE;let c,u;l.push(t.PRODUCTID),i[t.PRODUCTID]=i[t.PRODUCTID]||{},"true"===t.IGNORE?c=f.ignored:s(t)?(c=f.outdated,this.log.info("marking product as justUpdated; productId: "+t.PRODUCTID),i[t.PRODUCTID].justUpdated=!0,d.push(t.PRODUCTID)):c=n(t.STATUS),this.log.info("caching product type; productId: "+t.PRODUCTID+"; productType: "+c),i[t.PRODUCTID].type=c,i[t.PRODUCTID].canBeSelected=o(t),i[t.PRODUCTID].showWizard=t.FLAGS&&"true"===t.FLAGS.SHOWWIZARD,a&&t.UPDATES&&t.UPDATES.length&&(u=t.UPDATES.map((function(t){return{title:t.TITLE,url:t.URL}}))),r[c].push({productId:t.PRODUCTID,status:t.STATUS,name:t.NAME,vendor:t.VENDOR,currentVersion:t.CURRENTVERSION,updateTimestamp:t.UPDATETIMESTAMP?parseInt(t.UPDATETIMESTAMP,16):null,remoteVersion:t.REMOTEVERSION,error:t.DISPLAYERROR,icon:e,windowsUpdate:a,releaseNotes:t.RELEASENOTES,updates:u}),i[t.PRODUCTID].selected&&!i[t.PRODUCTID].canBeSelected&&(this.log.info("unselecting product; productId: "+t.PRODUCTID),delete i[t.PRODUCTID].selected),this.log.info("product added; productId: "+t.PRODUCTID)}))}.bind(this),s=function(t){return t.STATUS===g.upToDate&&i[t.PRODUCTID].type===f.outdated}.bind(this),n=function(t){let e;switch(t){case g.upToDate:case g.checking:e=f.updated;break;case g.readyToInstall:case g.updateAvailable:case g.downloading:case g.installing:case g.waitForAutoInstall:case g.failed:e=f.outdated}return e}.bind(this),o=function(t){if(this.isSmartScanV2)return this._includeStatuses(t,[g.readyToInstall,g.installing,g.downloading,g.upToDate]);const e=[g.installing,g.downloading,g.upToDate];return!this._includeStatuses(t,e)}.bind(this),a=function(){const t=this.get("productConfigs");d.forEach((e=>{const s=this.updateStatusTimeoutIds.indexOf(u);this.updateStatusTimeoutIds.splice(s,1),t[e]&&(delete t[e].justUpdated,t[e].type=f.updated)})),this.set("productConfigs",t),this.updateStatus()}.bind(this),i=this.get("productConfigs"),r=S(),d=[],l=[],c=[];let u;return t&&t.length&&t.forEach((t=>{c.push(e(t))})),Promise.all(c).then((()=>{this.log.info("all products already added/processed"),!this.isSmartScanV2&&d.length&&(u=setTimeout(a,4e3),this.updateStatusTimeoutIds.push(u));for(const t in i)l.includes(t)||(this.log.info("removing product config; productId: "+t),delete i[t]);this.log.info("products set and configs updated successfully");for(const t in f)r[t].sort(((t,e)=>{const s=t.name.toLowerCase(),n=e.name.toLowerCase();return s.localeCompare(n)})),this.merge("products."+t,r[t],{compare:"productId"});this.set("productConfigs",i),this.set("initStatus",_.done)}))},_startRefreshingModel(){u||this._modelRefreshCallInProgress||this._modelRefreshActive||(this._modelRefreshCallInProgress=!0,i("app.softwareupdater.StartAutomaticRefreshModel").then((()=>{this._modelRefreshActive=!0})).catch((t=>{console.error("app.softwareupdater.StartAutomaticRefreshModel",t)})).finally((()=>{this._modelRefreshCallInProgress=!1})))},_stopRefreshingModel(){u||!this._modelRefreshCallInProgress&&this._modelRefreshActive&&(this._modelRefreshCallInProgress=!0,i("app.softwareupdater.StopAutomaticRefreshModel").then((()=>{this._modelRefreshActive=!1})).catch((t=>{console.error("app.softwareupdater.stopAutomaticRefreshModel",t)})).finally((()=>{this._modelRefreshCallInProgress=!1})))},_cancelProductExpansion(t){this.set("productConfigs."+t+".expanded",!1)},_getSelectedProductIds(t){const e=this.get("productConfigs"),s=[];return this.get("products."+t).forEach((t=>{e[t.productId].selected&&s.push(t.productId)})),s},_getSelectedProductCount(t){const e=this.get("productConfigs");let s=0;return this.get("products."+t).forEach((t=>{e[t.productId].selected&&s++})),this.log.debug("selected product count: "+s),s},_updatedSelectedProductCounts(){this.log.info("updating selected product counts");const t=this.get("selectedProductCounts");for(const e in t)t[e]=this._getSelectedProductCount(e);this.set("selectedProductCounts",t)},_loadIcon(t){return t?this.iconCache[t]?Promise.resolve(this.iconCache[t]):i("app.utils.GetShellIcon",{path:t.replace(/\\\\/g,"\\"),size:"large"}).then((e=>(this.iconCache[t]=e.data,e.data))).catch((t=>{this.log.error("Loading icon failed",t)})):Promise.resolve()}}),P=m.get("STATUSES"),R=m.get("PRODUCT_STATUSES"),w=t.extend({template:{v:3,t:[{t:7,e:"div",a:{role:"row",class:["kin_table__row -smartscanV2 ",{t:2,x:{r:["isSelected"],s:'_0?"-selected":""'}}," ",{t:2,x:{r:["isDisabled"],s:'_0?"-disabled":""'}}],"data-test":["table-row-",{t:2,r:"@index"}],"aria-rowindex":[{t:2,r:"@index"}]},f:[{t:7,e:"label",a:{class:[{t:2,x:{r:["selectable"],s:'!_0?"-no-pointer":""'}}]},f:[{t:7,e:"div",a:{class:"kin_table__checkbox"},f:[{t:4,f:[{t:7,e:"input",v:{click:{n:"toggleProduct",d:[{t:2,r:"product"}]}},a:{type:"checkbox",class:"checkbox",checked:[{t:2,r:"isSelected"}],disabled:[{t:2,r:"isDisabled"}],"aria-label":[{t:2,x:{r:["nls"],s:'_0("global.selectItem")'}}," ",{t:2,r:"product.name"}],id:["swu-ss-item-",{t:2,r:"@index"}]}}],n:50,r:"selectable"}]}," ",{t:7,e:"div",a:{class:"kin_table__icon"},f:[{t:7,e:"img",a:{class:"swu_icon g-icon-shadow",height:"24",src:["data:gif/png;base64,",{t:2,r:"product.icon"}]}}," ",{t:4,f:[{t:7,e:"kin-icon",a:{class:"kin_table__icon__badge",name:"badge-ok",size:"16"}}],n:50,r:"productConfig.justUpdated"},{t:4,n:51,f:[{t:7,e:"kin-icon",a:{class:"kin_table__icon__badge",name:"badge-critical",size:"16"}}],r:"productConfig.justUpdated"}]}," ",{t:7,e:"div",a:{class:"kin_table__name",dir:"ltr"},f:[{t:2,r:"product.name"}]}]}," ",{t:7,e:"div",f:[{t:4,f:[{t:7,e:"p",a:{class:"p color-danger -text"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.userFix")'}}]}],n:50,x:{r:["product.status","STATUSES.updateAvailable"],s:"_0===_1"}},{t:4,n:51,f:[{t:4,n:50,x:{r:["product.status","STATUSES.failed"],s:"_0===_1"},f:[{t:7,e:"p",a:{class:"p color-danger -text"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.updateFailed")'}}]}]},{t:4,n:50,x:{r:["STATUSES.failed","product.status","STATUSES.waitForAutoInstall"],s:"(!(_1===_0))&&(_1===_2)"},f:[" ",{t:7,e:"div",f:[{t:7,e:"p",a:{class:"p color-danger -text"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.status.waitForAutoInstall")'}}]}," ",{t:7,e:"p",a:{class:"p -small -secondary"},f:[{t:4,f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.error.programRunning")'}}],n:50,x:{r:["product.error","ERRORS.PROGRAM_RUNNING"],s:"_0===_1"}},{t:4,n:51,f:[{t:4,n:50,x:{r:["product.error","ERRORS.REBOOT_REQUIRED"],s:"_0===_1"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.error.rebootRequired")'}}]},{t:4,n:50,x:{r:["ERRORS.REBOOT_REQUIRED","product.error","ERRORS.PROGRAM_RUNNING_USR2"],s:"(!(_1===_0))&&(_1===_2)"},f:[" ",{t:3,x:{r:["nls"],s:'_0("softwarehealth.error.anotherUserRunsProgram")'}}]}],x:{r:["product.error","ERRORS.PROGRAM_RUNNING"],s:"_0===_1"}}]}]}]},{t:4,n:50,x:{r:["STATUSES.failed","product.status","STATUSES.waitForAutoInstall","product.productConfig.type","TYPES.updated"],s:"(!(_1===_0))&&((!(_1===_2))&&(_3===_4))"},f:[" ",{t:7,e:"p",a:{class:"p"},f:[{t:3,x:{r:["nls","product.currentVersion"],s:'_0("softwarehealth.appCurrentVersion",_1)'}}]}]},{t:4,n:50,x:{r:["STATUSES.failed","product.status","STATUSES.waitForAutoInstall","product.productConfig.type","TYPES.updated"],s:"(!(_1===_0))&&((!(_1===_2))&&(!(_3===_4)))"},f:[" ",{t:7,e:"p",a:{class:"p"},f:[{t:2,r:"product.currentVersion"},"  >  ",{t:3,x:{r:["nls","product.remoteVersion"],s:'_0("softwarehealth.appNewVersion",_1)'}}," ",{t:4,f:[{t:7,e:"a",a:{class:"a",href:[{t:2,r:"product.releaseNotes"}]},v:{click:"browser"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.changeLog")'}}]}],n:50,x:{r:["product.windowsUpdate","product.releaseNotes"],s:"!_0&&_1"}}," ",{t:4,f:[{t:7,e:"br"}," ",{t:3,x:{r:["nls"],s:'_0("softwarehealth.changeLog")'}}," ",{t:4,f:[{t:7,e:"a",a:{href:[{t:2,r:"url"}],class:"a g-margin-left--5"},v:{click:"browser"},f:[{t:2,r:"title"}]}],n:52,i:"i",r:"product.updates"}],n:50,x:{r:["product.windowsUpdate","product.updates","product.updates.length"],s:"_0&&_1&&_2"}}]}]}],x:{r:["product.status","STATUSES.updateAvailable"],s:"_0===_1"}}]}," ",{t:4,f:[{t:7,e:"div",a:{class:"kin_table__actions swu_actions"},f:[{t:7,e:"kin-tooltip",f:[{t:7,e:"div",a:{slot:"tooltip-activator"},f:[{t:7,e:"kin-button",v:{click:{n:"ignoreProduct",d:[{t:2,r:"product"}]}},a:{size:"tiny",type:"blank",icononly:"true","aria-label":[{t:2,r:"product.name"}," - ",{t:3,x:{r:["nls"],s:'_0("softwarehealth.ignore")'}}]},f:[{t:7,e:"kin-icon",a:{name:"icon-s-controls-close",size:"10"}}]}]}," ",{t:7,e:"div",a:{slot:"tooltip"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ignore")'}}]}]}]}],n:50,x:{r:["ignorable","TYPES.updated","product.productConfig.type","TYPES.outdated"],s:"_0&&(_2===_1||_2===_3)"}},{t:4,n:51,f:[{t:7,e:"div",a:{class:"kin_table__end swu_actions"},f:[{t:4,f:[{t:7,e:"p",a:{class:"p"},f:[{t:7,e:"span",a:{class:"spinner -tiny g-margin-right--5"}}," ",{t:3,x:{r:["nls"],s:'_0("softwarehealth.downloading")'}}]}],n:50,x:{r:["product.status","STATUSES.downloading"],s:"_0===_1"}},{t:4,n:51,f:[{t:4,n:50,x:{r:["product.status","STATUSES.installing"],s:"_0===_1"},f:[{t:7,e:"p",a:{class:"p"},f:[{t:7,e:"span",a:{class:"spinner -tiny g-margin-right--5"}}," ",{t:3,x:{r:["nls"],s:'_0("softwarehealth.installing")'}}]}]},{t:4,n:50,x:{r:["product.status","STATUSES.installing","productConfig.justUpdated"],s:"(!(_0===_1))&&(_2)"},f:[" ",{t:7,e:"p",a:{class:"p color-ok -text"},f:[{t:3,x:{r:["nls"],s:'_0("softwarehealth.ss2.updated")'}}]}]}],x:{r:["product.status","STATUSES.downloading"],s:"_0===_1"}}]}],x:{r:["ignorable","TYPES.updated","product.productConfig.type","TYPES.outdated"],s:"_0&&(_2===_1||_2===_3)"}}]}]},data:()=>({STATUSES:R,ERRORS:m.get("ERRORS"),TYPES:m.get("PRODUCT_TYPES"),product:{},selectedByDefault:!1,selectable:!0,ignorable:null,status:m.get("status")}),computed:{isSelected:{set:function(){},get:function(){return this.get("product.productConfig.selected")}},isServiceReady:function(){return m.get("status")===P.ready},isDisabled:function(){const t=this.get("product.productConfig")||{},e=this.get("product.status");return!t.canBeSelected||t.justUpdated||"FAILED"===e||"WAITFORAUTOINSTALL"===e}},oninit(){m.observe("status",(t=>{this.set("status",t)})),this.unregisterConfigObserver=m.observe("productConfigs."+this.get("product.productId"),(t=>{this.set("product.productConfig",t)})).cancel,this.set("product.productConfig",m.get("productConfigs."+this.get("product.productId"))),this.on("toggleProduct",((t,e)=>{m.selectProduct(e,t.node.checked)})),this.on("ignoreProduct",((t,e)=>{m.ignoreProduct(e.productId).catch((()=>{r.inform(d("softwarehealth.ignoreProduct.error",e.name))}))}))},onrender(){const t=this.get("product");this.get("selectedByDefault")&&t.productConfig.canBeSelected&&m.selectProduct(t,!0)},onteardown(){this.unregisterConfigObserver&&this.unregisterConfigObserver()}});var U="[slot='table-header'] {\n  grid-template-columns: 4rem calc(4rem + 25%) 40% auto 5%;\n}\n.kin_table__row {\n  grid-template-columns: calc(4rem + 4rem + 25%) 40% auto 5%;\n}\n[slot='table-header'].-smartscanV2 {\n  grid-template-columns: 4rem calc(4rem + 25%) auto 25%;\n}\n.kin_table__row.-smartscanV2 {\n  grid-template-columns: calc(4rem + 4rem + 25%) auto 25%;\n}\n.swu_icon {\n  width: 3.2rem;\n  height: 3.2rem;\n  background-size: 100%;\n}\n.swu_sub-icon {\n  position: absolute;\n  top: 55%;\n  left: 2.5rem;\n}\n.swu_status-handler {\n  margin-top: 150px;\n}\n.swu_settings-upgradeBtn {\n  margin-left: 25px;\n}\n.swu_details {\n  margin: 0 11rem;\n}\n.swu_congrats {\n  text-align: center;\n  padding: 10px 0 30px;\n}\n.swu_congrats__icon {\n  border-radius: 100px;\n  font-size: 50px;\n  width: 80px;\n  height: 80px;\n  text-align: center;\n  line-height: 78px;\n  border-style: solid;\n  border-width: 1px;\n  margin-bottom: 15px;\n}\n.swu_banner {\n  background: #e9eaee;\n  padding: 10px 59px 10px 60px;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  justify-content: space-around;\n  margin-top: 20px;\n  border: solid 1px #eee;\n}\n.swu_banner a.a {\n  color: inherit;\n}\n.swu_banner__icon {\n  font-size: 40px;\n  margin-right: 25px;\n}\n.swu_banner__text {\n  flex-grow: 1;\n}\n.swu_banner .default-browser {\n  clear: both;\n}\n.swu_banner .default-browser div:first-child {\n  max-width: 420px;\n}\n.swu_banner .terms-text-right {\n  float: right;\n  max-width: 210px;\n  font-size: 1rem;\n  text-align: right;\n}\n[dir=rtl] .swu_banner {\n  padding: 10px 50px 10px 59px;\n}\n[dir=rtl] .swu_banner__icon {\n  font-size: 40px;\n  margin-right: 0;\n  margin-left: 30px;\n}\n[dir=rtl] .swu_auto-update {\n  float: left;\n}\n";const b=m.get("PRODUCT_TYPES.outdated"),x=m.get("PRODUCT_STATUSES"),I=m.get("PRODUCT_TYPES");const v=t.extend({template:l,css:U,components:{SmartScanItem:w},twoway:!1,scannerId:void 0,data:function(){return{scannerData:{progress:void 0,status:void 0,issuesCount:void 0},progress:0,products:m.get("products."+b),selectedProductCount:m.get("selectedProductCounts."+b),selectedProducts:m.get("selectedProducts"),selectableProducts:[],isResolving:!1,numberOfResolvingIssues:0,loading:!1,isOffline:!navigator.onLine,resolvingTakesTooLong:!1,noProducts:!1}},computed:{productsToBeUpdated:function(){const t=this.get("products"),e=Object.entries(m.get("productConfigs")).filter((t=>t[1].justUpdated));return t.length-e.length},failedProducts:function(){return this.get("products").filter((t=>["UPDATEAVALIABLE","WAITFORAUTOINSTALL","FAILED"].indexOf(t.status)>-1))}},oninit(){this.log=o.createLogger("softwareupdater.smartscan"),this.log.info("oninit"),this._addListeners()},_addListeners(){this._addSmartScanListeners(),this.on("selectAllProducts",(t=>{m.selectAllProducts(t.node.checked)})),this.on("selectAll",(()=>{m.selectAllProducts(!0)})),this.on("updateSelected",this.updateSelected.bind(this)),this.deselectAll=()=>{m.selectAllProducts(!1)},window.addEventListener("kin-deselectAll",this.deselectAll),this.updateOnlineStatusRef=this._updateOnlineStatus.bind(this),window.addEventListener("online",this.updateOnlineStatusRef),window.addEventListener("offline",this.updateOnlineStatusRef)},_addSmartScanListeners(){this.on("skip",(()=>{this.fire("trackSmartScanClick",{label:"skip"}),this.fire("skipScanner",{scannerId:this.scannerId})})),this.on("next",(()=>{this.fire("trackSmartScanClick",{label:"continue"}),this.fire("nextScanner")})),this.on("stop",(()=>{this.fire("trackSmartScanStop"),this.fire("stopScan")})),this.on("updateScannerData",(t=>{this.set("scannerData",{progress:t.progress,status:t.status,issuesCount:t.issuesCount}),"done"===t.status&&(t.issuesCount>0?(this._serviceInitCalled=!0,this.set("loading",!0),m.setSmartScanV2(!0),m.initialize(!1).then((()=>{setTimeout((()=>{this.trackResult("result")}),200)})),this._addObservers()):this.trackResult("result"))}))},_addObservers(){this.observe("products",(t=>{this.set("noProducts",0===t.length)})),m.observe("selectedProducts",(t=>{this.set("selectedProducts",t)})),m.observe("selectableProducts",(t=>{t&&t.length>0&&this.set("selectableProducts",t)})),m.observe("products."+b,((t,e)=>{if(this.log.info("products changed"),this.get("isResolving")){const e=m.get("selectedProducts"),s=t.filter((t=>e.indexOf(t.productId)>-1));s.length>0&&s.every((t=>["UPTODATE","FAILED","WAITFORAUTOINSTALL"].indexOf(t.status)>-1))&&(this.set("progress",100),setTimeout((()=>{0===this.get("productsToBeUpdated")&&this.fire("allIssuesResolved",this.scannerId),this.trackResult("resolved"),this.set({isResolving:!1}),this._clearResolvingTimeout()}),400))}0===t.length&&e&&e.length>0?(this.log.info("all products up-to-date"),this.set({allUpdated:!0})):this.merge("products",t,{compare:"productId"}),t.length>0&&this.set("loading",!1)})),m.observe("selectedProductCounts."+b,(t=>{this.set("selectedProductCount",t)}))},_updateOnlineStatus(){this.set("isOffline",!navigator.onLine)},dispatchScannerResults(t){const e={unresolved:t,resolved:this.get("scannerData.issuesCount")-t};this.fire("saveScannerResults",e)},updateSelected(){this.set({isResolving:!0,progress:0,numberOfResolvingIssues:this.get("selectedProducts").length}),this._startResolvingTimeout(),m.updateSelectedProducts()},_startResolvingTimeout(){this._resolvingTimeout=setTimeout((()=>{this.set("resolvingTakesTooLong",!0)}),3e5)},_clearResolvingTimeout(){clearTimeout(this._resolvingTimeout)},trackResult(t){const e=[];let s=0,n="DIRTY";for(const o of this.get("products"))o.status===x.updateAvailable?(n="DIRTY",s++):o.status===x.failed?(n="ERROR",s++):o.status===x.waitForAutoInstall?n="WARNING":o.productConfig&&(o.productConfig.type===I.updated||o.productConfig.justUpdated)?n="RESOLVED":(n="DIRTY",s++),e.push(`${o.name}|${o.currentVersion}|${o.remoteVersion}|${n}`);this.dispatchScannerResults(s),this.fire("trackSmartScanResult",{state:t,issuesCount:s,result:e})},onteardown(){window.removeEventListener("kin-deselectAll",this.deselectAll),this.deselectAll=void 0,this._serviceInitCalled&&m.destroy(),this._clearResolvingTimeout(),window.removeEventListener("online",this.updateOnlineStatusRef),window.removeEventListener("offline",this.updateOnlineStatusRef)}});export{v as SmartScanV2};const C={name:"software",version:"1.2.1288",created:"2023-07-12T11:53:23.997Z"};export{C as metadata};
